name: Download, Extract and Release Super/OEM

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: '要下载的文件URL'
        required: true
        type: string
      release_tag:
        description: 'Release标签 (例如: v1.0.0)'
        required: true
        type: string
      asset_name:
        description: 'Release资源名称'
        required: false
        type: string
        default: 'super-oem-files'

jobs:
  process-and-release:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download file
      run: |
        echo "正在下载文件: ${{ github.event.inputs.file_url }}"
        wget -O downloaded_file "${{ github.event.inputs.file_url }}"
        
        # 检查文件是否下载成功
        if [ ! -f "downloaded_file" ]; then
          echo "错误: 文件下载失败"
          exit 1
        fi
        
        echo "文件下载完成"
        ls -la downloaded_file

    - name: Extract files
      run: |
        echo "正在解压文件..."
        mkdir -p extracted_content
        
        # 根据文件类型进行解压
        file_type=$(file -b downloaded_file)
        echo "文件类型: $file_type"
        
        case "$file_type" in
          *"Zip archive"*)
            unzip downloaded_file -d extracted_content/
            ;;
          *"gzip compressed"*)
            tar -xzf downloaded_file -C extracted_content/
            ;;
          *"bzip2 compressed"*)
            tar -xjf downloaded_file -C extracted_content/
            ;;
          *"tar archive"*)
            tar -xf downloaded_file -C extracted_content/
            ;;
          *"7-zip archive"*)
            sudo apt-get update && sudo apt-get install -y p7zip-full
            7z x downloaded_file -oextracted_content/
            ;;
          *)
            echo "不支持的文件格式: $file_type"
            echo "尝试通用解压方法..."
            tar -xf downloaded_file -C extracted_content/ 2>/dev/null || \
            unzip downloaded_file -d extracted_content/ 2>/dev/null || \
            echo "无法解压文件，将检查原始文件"
            ;;
        esac
        
        echo "解压完成，内容列表:"
        find extracted_content/ -type f -name "*super*" -o -name "*oem*" | head -20

    - name: Find and archive super/oem files
      run: |
        echo "正在查找super和oem相关文件..."
        cd extracted_content
        
        # 查找所有包含super或oem的文件和目录
        find . -type f \( -iname "*super*" -o -iname "*oem*" \) | sort > ../file_list.txt
        
        # 检查是否找到了相关文件
        if [ ! -s ../file_list.txt ]; then
          echo "警告: 未找到包含'super'或'oem'的文件"
          echo "当前目录结构:"
          find . -type f | head -20
        else
          echo "找到的super/oem文件:"
          cat ../file_list.txt
        fi
        
        # 使用输入的资源名称，如果没有则使用默认值
        ASSET_NAME="${{ github.event.inputs.asset_name }}"
        if [ -z "$ASSET_NAME" ]; then
          ASSET_NAME="super-oem-files"
        fi
        
        # 创建只包含super和oem文件的tar.gz压缩包
        echo "正在创建tar.gz压缩包..."
        if [ -s ../file_list.txt ]; then
          # 如果找到了文件，只打包这些文件
          tar -czf "../${ASSET_NAME}.tar.gz" -T ../file_list.txt
        else
          # 如果没有找到特定文件，打包整个目录但保留名称
          echo "未找到特定文件，打包整个解压目录"
          tar -czf "../${ASSET_NAME}.tar.gz" .
        fi
        
        echo "压缩包创建完成:"
        ls -la "../${ASSET_NAME}.tar.gz"
        
        # 显示压缩包内容
        echo "压缩包内容:"
        tar -tzf "../${ASSET_NAME}.tar.gz" | head -20

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.release_tag }}
        name: Release ${{ github.event.inputs.release_tag }}
        body: |
          Super/OEM 文件 Release
          
          源文件: ${{ github.event.inputs.file_url }}
          包含: super和oem相关文件
          格式: tar.gz
          
          生成时间: ${{ github.workflow }} @ ${{ github.sha }}
        draft: false
        prerelease: false
        files: |
          *.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up
      run: |
        echo "清理临时文件..."
        rm -f downloaded_file
        rm -rf extracted_content
        rm -f *.tar.gz file_list.txt